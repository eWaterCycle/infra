---
- hosts: experiments
  tasks:
    - include_role:
        name: common
    - include_role:
        name: letsencrypt
    - name: Install git, ntp and pip
      apt:
        update_cache: yes
        name: "{{ item }}"
      loop:
        - git
        - ntp
        - python-setuptools
        - python-pip
    - name: Home root
      file:
        path: /mnt/home
        state: directory
    - name: Apps root
      file:
        path: /mnt/apps
        state: directory
    - name: Docker
      include_role:
        name: docker
      vars:
        - docker_root: "/mnt/docker"
- hosts: experiments
  tasks:
    - name: Docker pip
      pip:
        executable: pip
        name: "{{ item }}"
      loop:
        - docker
    - name: Forecast Docker images
      docker_image:
        name: '{{ item }}'
      with_items:
        - ewatercycle/ewatercycle_forecast_getforcing
        - ewatercycle/ewatercycle_forecast_preprocess
        - ewatercycle/ewatercycle_forecast
        - ewatercycle/ewatercycle_forecast_postprocess
    - name: Cylc
      include_role:
        name: cylc
    - name: Cylc-web
      include_role:
        name: cylc-web
    - name: Researchdrive
      include_role:
        name: researchdrive
      vars:
          researchdrive_src_dir: "{{ researchdrive.local_dir }}"
          researchdrive_dest_dir: "{{ researchdrive.remote_dir }}"
    - name: Add cylc user to researchdrive group
      user:
        name: cylc
        groups: [researchdrive]
        append: yes
- hosts: experiments
  tasks:
    - name: Set up synchronization of forecast datafiles to research drive
      block:
        - name: Configure log rotation of forecast cron log
          copy:
            src: forecast_cron_log
            dest: /etc/logrotate.d/forecast_cron_log
        - name: Ubuntu user should be member of syslog and researchdrive group
          user:
            name: ubuntu
            groups: [syslog, researchdrive]
            append: yes
        - name: Configure cron to mail
          cron:
            cron_file: forecast
            user: root
            name: MAILTO
            env: true
            value: '{{ cron_mailto }}'
        - name: Cron job for forecast check
          cron:
            cron_file: forecast
            user: ubuntu
            name: "Forecast check"
            minute: "0"
            job: "rclone check --exclude data/ {{ researchdrive_src_dir }} {{ researchdrive_dest_dir }} >> /var/log/forecast_cron.log 2>&1"
        - name: Cron job for forecast sync
          cron:
            cron_file: forecast
            user: ubuntu
            name: "Forecast sync"
            minute: "1"
            job: "rclone copy --exclude data/ --retries-sleep 30s {{ researchdrive_src_dir }} {{ researchdrive_dest_dir }} >> /var/log/forecast_cron.log 2>&1"
