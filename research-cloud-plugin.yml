- name: Install and configure eWaterCycle Jupyter
  hosts:
    - localhost
  gather_facts: false
  tasks:
    - name: Wait for system to become reachable
      wait_for_connection:
        timeout: 300

    - name: Gather facts for first time
      setup:

    - include_role:
        name: common
      tags:
        - ssh
      vars:
         extra_disks: []
    - name: Install gcc, git, ntp
      apt:
        update_cache: yes
        pkg:
          - git
          - gcc
          - g++
          - make
          - ntp
          - tmux
          - ksh
          - acl

    # roles have hardcoded /mnt/apps, so create it before running roles
    - name: Apps root
      file:
        path: /mnt/apps
        state: directory

    # Container engines
    # - name: Docker
    #   include_role:
    #     name: docker
    #     # TODO User needs to be in docker group to use docker without password
    #     # See RSC-CO plugin with co_passwordless_sudo for hints
    - name: singularity
      include_role:
        name: singularity

    # Prepare Jupyter kernel
    - name: Install conda
      include_role:
        name: conda
      vars:
        conda_tarball_root: /opt
        conda_root: /opt/conda

    # TODO mount climate disk
    # TODO mount parameter set disk
    # TODO mount singularity images disk
    # TODO mount scratch disk
    # TODO mount persistent home disk

    # https://lab.ewatercycle.org/ functionality
    - include_role:
        name: labstart
      vars:
        tool_urls:
          explore: https://{{ ansible_host }}
          jupyter: https://{{ ansible_host }}/jupyter
        # TODO launcher_jupyterhub_token is now set as RC plugin pararmeter
        # need to to make random for each instance

    # https://explore.ewatercycle.org/ functionality
    - include_role:
        name: launcher
      vars:
        launcher_encrypted: false
        jupyterhub_url: https://{{ ansible_host }}/jupyter
    - include_role:
        name: terria
      vars:
        jupyterhub_url: https://{{ ansible_host }}/jupyter

    # https://jupyter.ewatercycle.org/ functionality
    - name: Create eWaterCycle conda env
      include_role:
        name: ewatercycle

    - name: Set up Jupyter lab/hub
      include_role:
        name: jupyter ## TODO replace partly with https://gitlab.com/rsc-surf-nl/rsc-plugins/-/blob/master/ansible/application-jupyter/application-jupyter.yml
    # - name: grdc
    #   include_role:
    #     name: grdc

      # TODO do all steps on https://ewatercycle.readthedocs.io/en/latest/system_setup.html

    - debug:
        msg: The eWaterCycle Jupyter plugin has completed

# TODO Stuff to ask Research Cloud helpdesk
# 1. How to use task from Ansible galaxy?
# 2. How to become root after creation, see https://servicedesk.surfsara.nl/wiki/display/WIKI/RC+plugin+passwordless+sudo
# 3. How to add users to docker posix group
# 4. How to generate a random string (launcher_jupyterhub_token) for each instantiation, dont want to ask during new workspace
# 5. How to get live log from my own plugin installation
# 6. How to mark certain user as JupyterHub admin
