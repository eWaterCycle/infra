- name: Install and configure eWaterCycle Jupyter
  hosts:
    - all
    - localhost
  gather_facts: false
  vars:
    # dCache token for mounting shared data
    dcache_ro_token: null # Must be filled from command line
    terriamap_version: 44d412efac4d031d7e31af7727459156644dec32
    terriajs_version: b137ef40108f6897ee4d382314dde99a79de80d5
    launcher_version: cee61d0c0c4ca1f4bd28a0a56467f42176ffd78b
  tasks:
    - name: Wait for system to become reachable
      wait_for_connection:
        timeout: 300

    - name: Gather facts for first time
      setup:

    - name: Common stuff
      include_role:
        name: common

    - name: Install gcc, git, ntp
      apt:
        update_cache: yes
        pkg:
          - git
          - gcc
          - g++
          - make
          - ntp
          - tmux
          - ksh
          - acl
          - net-tools

    # roles have hardcoded /mnt/apps, so create it before running roles
    - name: Apps root
      file:
        path: /mnt/apps
        state: directory
        mode: 0755

    # Container engines
    - name: singularity
      include_role:
        name: singularity

    # Install Conda + mamba
    - name: Install conda
      include_role:
        name: conda

    # OS disk almost full need more room for users. Lets have a scratch and home as additional SRC storage items
    # TODO mount a scratch disk, it should not persist and mabye even remove files older than 14 days
    # - name: Scratch disk
    #   mount:
    #     path: /scratch
    #     src: TODO # Some value extracted from SRC API or ansible vars/facts
    #     state: present
    # TODO mount persistent home disk
    # TODO will need to copy /home mounted on root disk to temp home, perform mount, copy temp home to new home and remove temp home
    # - name: Home disk
    #   mount:
    #     path: /home
    #     src: TODO # Some value extracted from SRC API or ansible vars/facts
    #     state: present

    - name: Mount shared data dcache with rclone
      include_role:
        name: rclone
        tasks_from: mount

    # https://lab.ewatercycle.org/ functionality
    - name: Welcome page
      include_role:
        name: labstart

    # https://explore.ewatercycle.org/ functionality
    - name: Experiment launcher
      include_role:
        name: launcher

    - name: Explorer
      include_role:
        name: terria

    # https://jupyter.ewatercycle.org/ functionality
    - name: Create eWaterCycle conda env
      include_role:
        name: ewatercycle

    - name: Set up Jupyter lab/hub
      include_role:
        name: jupyter

    - name: Clean apt cache
      apt:
        autoclean: yes
        autoremove: yes

    - name: Debug
      debug:
        msg: The eWaterCycle Jupyter plugin has completed
