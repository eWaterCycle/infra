---
# tasks file for ewatercycle

- name: Stage conda env file
  copy:
    src: environment.yml
    dest: '{{ conda_root }}/environment.yml'

- name: Install/update eWaterCycle conda environment
  # TODO mamba installs packages requiring mpi, falling back to conda to get nompi packages?
  command: '{{ conda_root }}/condabin/conda env update --file {{ conda_root }}/environment.yml'

- name: eWaterCycle pip dependencies
  pip:
    executable: '{{ conda_root }}/envs/ewatercycle/bin/pip3'
    name:
      - jupyterlab_thredds==0.5.0
      # TODO install ewatercycle from PyPI instead of GH
      - git+https://github.com/eWaterCycle/ewatercycle
- name: Activate eWaterCycle conda environment during login for all posix_users
  lineinfile:
    path: /etc/profile.d/conda.sh
    line: conda activate ewatercycle
    regexp: '^conda activate ewatercycle'

# TODO remove: Disk mounted which already has files
# - name: Data for esmvaltool
#   include: esmvaltool-data.yml

# Checklist system setup https://ewatercycle.readthedocs.io/en/latest/system_setup.html :
# Conda environment -> done on line 10
# Install ewatercycle package -> done on line 18
# Configure ESMValTool -> done on line 42-49
# Download climate data -> mounted on /data/volume_2/esmvaltool
# Install container engine -> done in singularity role
# Configure ewatercycle -> done on line 51-54
# Model container images -> mounted on /data/volume_2/singularity-images
# Download example parameter sets -> mounted on /data/volume_2/parameter-sets
# Prepare other parameter sets -> mounted on /data/volume_2/parameter-sets
# Download example forcing -> mounted on /data/volume_2/forcings
# Download observation data -> mounted on /data/volume_2/observation

- name: ESMValTool configuration directory
  file:
    path: /etc/skel/.esmvaltool
    state: directory
- name: ESMValTool config-user.yml
  template:
    src: config-user.yml.j2
    dest: /etc/skel/.esmvaltool/config-user.yml

- name: ewaterycle.yaml
  template:
    src: ewatercycle.yaml.j2
    dest: /etc/ewatercycle.yaml
